#!/bin/bash
#
# Clem
#
# This script is used to start a virtual machine
# 
# For info see README


if [ "x$#" != "x4" ]; then
    echo "This script should be invoked with 4 arguments"
    exit 1
fi

function error(){
    echo -e "Error $1"
    exit 1
}

# tree required arguments
temp_disk_path=$1
fqdn=$2
temp_directory=$3
vc_out_filepath=$4


# get the path to this script
pushd `dirname $0` > /dev/null
SCRIPTPATH=`pwd`
popd > /dev/null

#
#    ----------------       fixing the disk image  -------------------
#
tmp_folder=`mktemp -d`

fe_fqdn=`echo "cat /vc/frontend/public/@fqdn" | xmllint --shell $vc_out_filepath | grep = | awk -F \" '{print $2}'`
#dns=`echo "cat /vc/compute/node/@ip" | xmllint --shell $vc_out_filepath | grep = | awk -F \" '{print $2}'`


guestmount -a $temp_disk_path -m /dev/sda1 $tmp_folder || error "unable to mount guest FS"

if [ "x$fqdn" = "x$fe_fqdn" ]; then
	# this is a frontend
	xml_file="$vc_out_filepath"
else 
	# this is a compute node and we have created all the xml file in allocate
	# they are in temp_dir/hostname.xml
	xml_file="$temp_directory/$fqdn.xml"
fi

# copy the vc-out.xml
cp $xml_file $tmp_folder/root/vc-out.xml

fusermount -u $tmp_folder || error "unable to unmount $tmp_folder"
rmdir $tmp_folder


#
#    ----------------       deploying disk image and booting  -------------------
#
# match everything except 'HOST' and a line of -----
container=`rocks list host vm $fqdn | awk '{if (! /---*/ && ! /HOST/) print $5}'`
disk_path=`rocks list host vm $fqdn showdisks=1 | awk ' {if (/file/) print $7}'`
# remove useless stuff from file path
disk_path=${disk_path#file:}
disk_path=${disk_path/,*/}

localhost=`hostname -s`

echo Destination disk path is $container:$disk_path

if [ "$container" = "$localhost" ];then
	echo dd if=$temp_disk_path of=$disk_path bs=1M
	dd if=$temp_disk_path of=$disk_path bs=1M \
		|| error "unable to copy the disk image $temp_disk_path to $disk_path"
else
	echo scp $temp_disk_path $container:$disk_path
	scp $temp_disk_path $container:$disk_path \
		|| error "unable to copy the disk image $temp_disk_path to $container:$disk_path"
fi

# do not install just boot the system as it is
rocks set host boot $fqdn action=os
rocks start host vm $fqdn

